# 🧹 STT 할루시네이션 자동 정리 도구

음성 인식(STT) 결과에서 발생하는 할루시네이션(환각, 반복 패턴)을 자동으로 감지하고 제거하는 기능입니다.

## 🎉 자동 통합 완료!

**2026년 1월 20일부터 mp3_to_text.py에 자동으로 통합되었습니다!**
- 변환 완료 후 자동으로 할루시네이션 제거
- 별도로 스크립트를 실행할 필요 없음
- `--no-clean` 옵션으로 비활성화 가능

## 📋 할루시네이션이란?

STT 모델이 다음과 같은 상황에서 잘못된 결과를 반복 생성하는 현상:
- 오디오 품질이 낮거나 배경음악/소음이 있을 때
- 음악만 나오고 음성이 없는 구간
- 불확실한 구간을 모델이 계속 같은 패턴으로 예측

### 예시

**할루시네이션이 있는 경우:**
```
| 16:53 | 오퍼를 좋아해? |
| 16:58 | 오퍼를 좋아해? |
| 16:59 | 오퍼를 좋아해? |
| 16:59 | 오퍼를 좋아해? |
| 17:00 | 오퍼를 좋아해? |
... (20번 이상 반복)
| 32:17 | 다음 영상에서 만나요. |
| 32:47 | 다음 영상에서 만나요. |
| 33:17 | 다음 영상에서 만나요. |
| 17:25 | 그녀는 그녀는 그녀는 그녀는 그녀는 그녀는... |
```

**정리된 결과:**
```
| 16:53 | 너는 오페라를 좋아해? |
| 17:25 | [오페라 음악 - 약 1분간] |
| 32:17 | [음악 - The Streets of Philadelphia] |
```

## 🚀 사용법

### 1️⃣ 자동 모드 (권장) - 변환과 동시에 적용

```bash
# 기본 사용 (할루시네이션 자동 제거 활성화)
python3 src/mp3_to_text.py audio.mp3

# 할루시네이션 제거 비활성화
python3 src/mp3_to_text.py audio.mp3 --no-clean

# 디렉토리 일괄 변환 (자동 제거 포함)
python3 src/mp3_to_text.py --dir ./mp3
```

### 2️⃣ 수동 모드 - 이미 변환된 파일에 적용

```bash
# 단일 파일 정리
python3 src/fix_hallucination.py "mp3/CD6_기타/필라델피아_A_time.md"

# 상세 정보 출력 (어떤 부분이 제거되었는지 확인)
python3 src/fix_hallucination.py "mp3/CD6_기타/필라델피아_A_time.md" -v

# 백업 없이 실행 (권장하지 않음)
python3 src/fix_hallucination.py "mp3/CD6_기타/필라델피아_A_time.md" --no-backup

# 반복 임계값 조정 (기본값: 3)
python3 src/fix_hallucination.py "mp3/CD6_기타/필라델피아_A_time.md" --threshold 5
```

### 옵션

**자동 모드 (mp3_to_text.py):**
| 옵션 | 설명 | 기본값 |
|-----|------|--------|
| `--no-clean` | 할루시네이션 자동 제거 비활성화 | False (자동 제거) |

**수동 모드 (src/fix_hallucination.py):**
| 옵션 | 설명 | 기본값 |
|-----|------|--------|
| `-v`, `--verbose` | 상세 정보 출력 | False |
| `--no-backup` | 백업 파일 생성 안 함 | False (백업 생성) |
| `--threshold N` | 반복으로 간주할 최소 횟수 | 3 |

## 🔍 감지 기능

스크립트가 자동으로 감지하는 패턴:

1. **연속 동일 내용** (3회 이상)
   - 같은 텍스트가 연속으로 나오는 경우
   - 예: "오퍼를 좋아해?" 23회 반복

2. **짧은 구문 반복** (5회 이상)
   - 짧은 문장이나 단어가 반복되는 경우
   - 예: "다음 영상에서 만나요." 5회 반복

3. **단어 반복**
   - 같은 단어가 3번 이상 연속으로 나오는 경우
   - 예: "그녀는 그녀는 그녀는" → "그녀는"

4. **문자 패턴 반복**
   - 짧은 문자열이 여러 번 반복되는 경우
   - 예: "불에 불에 불에" → "불에"

5. **명백한 할루시네이션**
   - 같은 글자가 80% 이상인 경우
   - 자음/모음만 있는 경우
   - 의미 없는 반복 패턴

## 📊 실행 결과 예시

```
📄 분석 중: 필라델피아_A_time.md
📊 총 243개 엔트리 발견

🔍 감지된 반복 구간:
  - 라인 140~162: "오퍼를 좋아해?..." (23회 반복)
  - 라인 238~242: "다음 영상에서 만나요...." (5회 반복)

🔍 감지된 짧은 반복 패턴:
  - " 오퍼를 좋아해?"
  - " 다음 영상에서 만나요."
  - " 그녀의 어머니가 죽었고,"

📈 통계:
   원본: 243개 엔트리
   정리 후: 217개 엔트리
   제거됨: 26개 (10.7%)

💾 백업 저장: mp3/CD6_기타/필라델피아_A_time.backup.md
✅ 정리 완료: mp3/CD6_기타/필라델피아_A_time.md
```

## 💾 백업

- 기본적으로 원본 파일은 `.backup.md` 확장자로 자동 백업됩니다
- 예: `필라델피아_A_time.md` → `필라델피아_A_time.backup.md`
- 백업을 원하지 않으면 `--no-backup` 옵션 사용

## ⚠️ 주의사항

1. **수동 검토 권장**: 자동화 도구이지만 완벽하지 않으므로, 중요한 파일은 결과를 검토하세요
2. **백업 확인**: 작업 전에 백업이 생성되었는지 확인하세요
3. **임계값 조정**: 파일에 따라 `--threshold` 값을 조정할 수 있습니다
4. **음악 구간**: 음악만 나오는 긴 구간은 수동으로 `[음악 - 제목]` 형태로 표시하는 것이 좋습니다

## 🛠️ 배치 처리

여러 파일을 한 번에 처리하려면:

```bash
# 특정 디렉토리의 모든 *_time.md 파일 처리
find mp3/ -name "*_time.md" -type f | while read file; do
    echo "처리 중: $file"
    python3 src/fix_hallucination.py "$file"
done

# 또는 for 루프 사용
for file in mp3/*/*_time.md; do
    python3 src/fix_hallucination.py "$file" -v
done
```

## 📝 파일 형식

이 스크립트는 다음 형식의 마크다운 파일을 처리합니다:

```markdown
# ⏱️ Audio Transcription - Time Intervals

> **파일**: `example.mp3`  

---

| 시간 | 내용 |
|---|---|
| 00:00 | 첫 번째 내용 |
| 00:30 | 두 번째 내용 |
```

## 🐛 문제 해결

### 정규표현식 오류
```
re.error: invalid group reference
```
→ 스크립트를 최신 버전으로 업데이트하세요

### 백업 파일이 생성되지 않음
→ 파일 경로와 쓰기 권한을 확인하세요

### 너무 많은/적은 내용이 제거됨
→ `--threshold` 값을 조정하세요 (더 엄격하게: 값 증가, 더 느슨하게: 값 감소)

## 📈 성과

실제 사용 예시 (필라델피아_A_time.md):
- **원본**: 256 라인 (243개 엔트리)
- **정리 후**: 224 라인 (217개 엔트리)
- **제거됨**: 31 라인 (26개 중복 엔트리 + 수동 정리)
- **개선율**: 약 12% 압축, 가독성 크게 향상

## 📚 관련 파일

- `src/fix_hallucination.py` - 메인 스크립트
- `src/mp3_to_text.py` - 통합된 변환 스크립트
- `*.backup.md` - 자동 생성된 백업 파일
- `*_time.md` - 처리 대상 파일 (시간별 변환 결과)
- `*_full.md` - 전체 변환 결과 (시간 정보 없음)

## 🤝 기여

버그 리포트나 개선 제안은 언제든 환영합니다!
