# 🔄 User Flow - 사용자 흐름도
## MP3 to Text Converter

---

## 1. 전체 사용자 여정

```mermaid
journey
    title MP3 to Text 변환 여정
    section 시작
      오디오 파일 준비: 5: User
      도구 선택 (CLI/GUI/Web/Batch): 3: User
    section 변환
      파일 업로드/선택: 4: User
      설정 조정: 3: User
      변환 시작: 5: User
      진행 상황 확인: 4: User
    section 완료
      결과 확인: 5: User
      할루시네이션 자동 제거: 5: System
      파일 저장/복사: 4: User
```

---

## 2. CLI 사용자 흐름

```mermaid
flowchart TD
    A[시작] --> B{오디오 파일 있음?}
    B -->|예| C[명령어 입력]
    B -->|아니오| Z[종료]
    
    C --> D{옵션 선택}
    D --> E[기본 변환<br/>python mp3_to_text.py audio.mp3]
    D --> F[디렉터리 변환<br/>--dir]
    D --> G[VAD 활성화<br/>--vad]
    D --> G2[BGM 모드 비활성화<br/>--no-bgm]
    D --> G3[문맥 참조<br/>--context]
    
    E --> H[모델 로딩]
    F --> H
    G --> H
    G2 --> H
    G3 --> H
    
    H --> I[변환 진행]
    I --> J{완료?}
    J -->|진행중| K[실시간 진행률 표시]
    K --> I
    J -->|완료| L[결과 파일 생성]
    J -->|중단 Ctrl+C| M[현재까지 저장]
    
    L --> N[할루시네이션 자동 제거]
    N --> O[결과 확인]
    M --> O
    O --> Z
```

### 2.1 CLI 명령어 예시

```bash
# 1. 기본 변환 (자동으로 _time.md, _full.md 생성)
python src/mp3_to_text.py audio.mp3

# 2. 파일로 저장 (단일 txt)
python src/mp3_to_text.py audio.mp3 -o result.txt

# 3. VAD 활성화 (음성 구간만 처리)
python src/mp3_to_text.py audio.mp3 --vad

# 4. 디렉터리 일괄 처리
python src/mp3_to_text.py --dir ./mp3

# 5. 시간 간격 조정 (60초 단위)
python src/mp3_to_text.py --dir ./mp3 --interval 60

# 6. BGM 모드 비활성화 (일반 음성용)
python src/mp3_to_text.py audio.mp3 --no-bgm

# 7. 이전 문맥 참조 활성화
python src/mp3_to_text.py audio.mp3 --context
```

---

## 3. 일괄 변환 (Batch) 사용자 흐름

```mermaid
flowchart TD
    A[시작] --> B[convert_all.sh 실행]
    B --> C[mp3 디렉터리 스캔]
    C --> D[모든 depth 탐색]
    D --> E[오디오 파일 있는 디렉터리 추출]
    
    E --> F{디렉터리 목록 확인}
    F -->|-y 옵션| G[자동 시작]
    F -->|수동| H[사용자 확인]
    H -->|y| G
    H -->|n| Z[종료]
    
    G --> I[각 디렉터리 처리]
    I --> J[python mp3_to_text.py --dir]
    J --> K[할루시네이션 자동 제거]
    K --> L{다음 디렉터리?}
    L -->|예| I
    L -->|아니오| M[완료 보고]
    M --> Z
```

### 3.1 Batch 명령어 예시

```bash
# 1. 기본 실행 (확인 프롬프트)
./convert_all.sh

# 2. 백그라운드 실행 (nohup)
nohup ./convert_all.sh -y > convert_all.log 2>&1 &

# 3. VAD 활성화
./convert_all.sh --vad -y

# 4. 시간 간격 조정
./convert_all.sh --interval 60 -y

# 5. 진행 상황 확인
tail -f convert_all.log
```

---

## 4. Gradio GUI 사용자 흐름

```mermaid
flowchart TD
    A[브라우저에서<br/>localhost:7860 접속] --> B[파일 업로드]
    B --> C{설정 조정}
    
    C --> D[모델 선택<br/>small/medium/large-v3]
    C --> E[언어 선택<br/>ko/en/ja/...]
    C --> F[VAD 토글]
    
    D --> G[변환 버튼 클릭]
    E --> G
    F --> G
    
    G --> H[진행률 표시]
    H --> I{완료?}
    I -->|진행중| H
    I -->|완료| J[결과 텍스트 표시]
    
    J --> K{저장?}
    K -->|예| L[파일로 저장 버튼]
    K -->|아니오| M[복사하여 사용]
    
    L --> N[저장 완료 메시지]
    M --> N
    N --> O{추가 변환?}
    O -->|예| B
    O -->|아니오| P[종료]
```

### 4.1 Gradio GUI 화면 구성

```
┌─────────────────────────────────────────────────────────────────────┐
│ 🎤 MP3 → 텍스트 변환기                                              │
├───────────────────────────┬─────────────────────────────────────────┤
│                           │                                          │
│  📁 파일 업로드           │  📝 변환 결과                            │
│  ┌─────────────────────┐  │  ┌────────────────────────────────────┐ │
│  │ [audio.mp3 ▼]       │  │  │                                    │ │
│  └─────────────────────┘  │  │  FM영화음악 정은임입니다.          │ │
│                           │  │  오늘 첫 번째 곡은...              │ │
│  ⚙️ 설정                  │  │                                    │ │
│  모델: [large-v3 ▼]       │  │                                    │ │
│  언어: [ko ▼]             │  │                                    │ │
│  ☐ VAD 활성화             │  │                                    │ │
│                           │  │                                    │ │
│  [🎯 변환 시작]           │  └────────────────────────────────────┘ │
│                           │                                          │
│  ⏳ 진행 상황             │  [💾 저장]                               │
│  ████████░░░░ 65%         │                                          │
│  12:30/19:00 ETA: 2:15    │                                          │
│                           │                                          │
└───────────────────────────┴─────────────────────────────────────────┘
```

---

## 5. Flask Web UI 사용자 흐름

```mermaid
flowchart TD
    A[브라우저에서<br/>localhost:5001 접속] --> B{입력 방식 선택}
    
    B -->|파일 업로드| C[파일 드래그 앤 드롭]
    B -->|경로 입력| D[오디오 파일 경로 입력]
    
    C --> E[모델 선택]
    D --> E
    
    E --> F[변환 시작 버튼]
    F --> G[실시간 진행률 표시]
    G --> H[세그먼트 로그 표시]
    H --> I{완료?}
    I -->|진행중| G
    I -->|완료| J[결과 표시]
    
    J --> K{저장 방식}
    K -->|복사| L[클립보드 복사]
    K -->|다운로드| M[파일 다운로드]
    K -->|새로 시작| N[폼 초기화]
    
    L --> O[완료]
    M --> O
    N --> B
```

### 5.1 Flask Web UI 화면 구성

```
┌─────────────────────────────────────────────────────────────────────┐
│ 🎤 MP3 → Text Converter                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📁 오디오 파일 선택                                                 │
│  ┌─────────────────┬─────────────────┐                              │
│  │ 📤 파일 업로드  │ 📂 경로 입력    │  ← 탭 전환                   │
│  └─────────────────┴─────────────────┘                              │
│                                                                      │
│  ┌─────────────────────────────────────┐                            │
│  │ 클릭하거나 파일을 드래그하세요      │                            │
│  │ MP3, WAV, FLAC, M4A 지원            │                            │
│  └─────────────────────────────────────┘                            │
│                                                                      │
│  모델 선택: [Large-v3 (~3GB) ▼]                                     │
│                                                                      │
│  [🚀 변환 시작]                                                      │
│                                                                      │
├─────────────────────────────────────────────────────────────────────┤
│  📊 진행 상황                                                        │
│  ┌─────────────────────────────┐                                    │
│  │ ⏳ 변환 중...               │                                    │
│  │ ████████████░░░░░░ 65%      │                                    │
│  │ 세그먼트: 45개 | 경과: 3:20 │                                    │
│  └─────────────────────────────┘                                    │
│                                                                      │
│  📜 실시간 로그                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ [0.00s → 2.50s] FM영화음악 정은임입니다.                    │    │
│  │ [2.50s → 5.30s] 오늘 첫 번째 곡은...                        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
├─────────────────────────────────────────────────────────────────────┤
│  ✅ 변환 완료                                                        │
│  [📋 복사] [💾 다운로드] [🔄 새로 시작]                             │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ 변환된 전체 텍스트...                                       │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. Tkinter GUI 사용자 흐름

```mermaid
flowchart TD
    A[app_tkinter.py 실행] --> B[메인 윈도우 표시]
    B --> C{설정 조정}
    
    C --> D[모델 선택<br/>base/small/medium/large-v3]
    C --> E[언어 선택<br/>ko/en/ja/zh/auto]
    C --> F[타임스탬프 옵션]
    
    D --> G[파일 선택 버튼 클릭]
    E --> G
    F --> G
    
    G --> H[파일 선택 대화상자]
    H --> I{파일 선택?}
    I -->|예| J[변환 시작]
    I -->|아니오| G
    
    J --> K[진행 상황 표시]
    K --> L{완료?}
    L -->|진행중| K
    L -->|완료| M[결과 텍스트 표시]
    
    M --> N{저장?}
    N -->|예| O[저장 대화상자]
    O --> P[파일 저장]
    N -->|아니오| Q[종료 또는 새 파일]
```

### 6.1 Tkinter GUI 화면 구성

```
┌─────────────────────────────────────────────────────────────────────┐
│ 🎤 MP3 → 텍스트 변환기                                              │
│ 완전 무료 · 로컬 실행 · 한국어 최적화                               │
├─────────────────────────────────────────────────────────────────────┤
│  모델:  ○ base (빠름)  ○ small (양호)  ○ medium (추천)             │
│         ○ large-v3 (최고)                                           │
│                                                                      │
│  언어:  [ko (한국어) ▼]        ☐ 타임스탬프 표시                    │
├─────────────────────────────────────────────────────────────────────┤
│  [📁 파일 선택 및 변환]  [💾 저장]              상태: 준비됨        │
├─────────────────────────────────────────────────────────────────────┤
│  📝 변환 결과                                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                                                              │    │
│  │  변환된 텍스트가 여기에 표시됩니다...                        │    │
│  │                                                              │    │
│  │                                                              │    │
│  │                                                              │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. 할루시네이션 후처리 흐름

```mermaid
flowchart TD
    A[변환 완료] --> B{자동 정리 활성화?}
    B -->|예| C[_remove_hallucination 호출]
    C --> D[반복 패턴 감지]
    D --> E[제거 및 파일 업데이트]
    E --> F[결과 보고]
    
    B -->|아니오| G[수동 후처리 필요]
    G --> H[fix_hallucination.py 실행]
    H --> I[백업 생성]
    I --> D
    
    F --> Z[완료]
```

### 7.1 수동 후처리 명령어

```bash
# 1. 기본 실행 (백업 자동 생성)
python src/fix_hallucination.py audio_time.md

# 2. 상세 정보 출력
python src/fix_hallucination.py audio_time.md -v

# 3. 백업 없이 처리
python src/fix_hallucination.py audio_time.md --no-backup

# 4. 반복 임계값 조정 (기본: 3)
python src/fix_hallucination.py audio_time.md --threshold 5

# 5. 전체 디렉터리 일괄 처리
find mp3 -name "*_time.md" | while read f; do
    python src/fix_hallucination.py "$f" --no-backup
done
```

---

## 8. 에러 상황 흐름

```mermaid
flowchart TD
    A[변환 시작] --> B{파일 유효?}
    B -->|아니오| C[파일 없음 에러]
    C --> D[다른 파일 선택]
    D --> A
    
    B -->|예| E{모델 로딩 성공?}
    E -->|아니오| F[모델 다운로드 필요]
    F --> G[자동 다운로드]
    G --> E
    
    E -->|예| H[변환 진행]
    H --> I{ffprobe 있음?}
    I -->|아니오| J[경고 표시, 계속 진행]
    I -->|예| K[오디오 전처리]
    
    J --> L[변환 계속]
    K --> L
    L --> M{사용자 중단?}
    M -->|예| N[현재까지 저장]
    M -->|아니오| O{변환 완료?}
    
    O -->|아니오| L
    O -->|예| P[성공]
    N --> Q[부분 결과 확인]
```

---

## 9. 출력 파일 구조

```
mp3/
├── audio.mp3                 # 원본 오디오
├── audio_full.md             # 전체 텍스트
├── audio_time.md             # 시간대별 텍스트
├── subdirectory/             # 깊은 depth도 지원
│   ├── audio2.mp3
│   ├── audio2_full.md
│   └── audio2_time.md
└── log/
    └── 2026-01-21.md         # 일자별 변환 로그
```

---

*문서 버전: 1.2*
*최종 수정: 2026-01-21*
